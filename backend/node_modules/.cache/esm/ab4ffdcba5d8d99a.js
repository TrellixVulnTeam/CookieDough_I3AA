let User,colName,jwt,dotenv;_a5d‍.x([["signIn",()=>signIn],["signOut",()=>signOut],["signUp",()=>signUp]]);_a5d‍.w("../models",[["User",["User"],function(v){User=v}]]);_a5d‍.w("../models/UserSchema",[["colName",["colName"],function(v){colName=v}]]);_a5d‍.w("jsonwebtoken",[["default",["jwt"],function(v){jwt=v}]]);_a5d‍.w("dotenv",[["default",["dotenv"],function(v){dotenv=v}]]);




dotenv.config({path: '../../env'});

const JWT_COOKIE_NAME = 'jwt';
const MAX_TOKEN_AGE_SEC = 28800;

const signIn = async function(req, res, next){
	try{
		const user = await User.findOne({[colName.EMAIL]: req.body[colName.EMAIL]});
		
		const isMatched = await user.comparePassword(req.body[colName.PASSWORD]);
		
		if(isMatched){
			const token = jwt.sign({
				id: user.id,
				[colName.EMAIL]: user[colName.EMAIL],
				[colName.NAME]: user[colName.NAME]
			},process.env.SECRET_KEY);
			_a5d‍.g.console.log(token);
			res.status(200).cookie(
				JWT_COOKIE_NAME,
				token,
				{
					httpOnly: true,
					maxAge: MAX_TOKEN_AGE_SEC
				}
			).json({
				id: user.id,
				[colName.EMAIL]: user[colName.EMAIL],
				[colName.NAME]: user[colName.NAME]
			});
		}
		else{
			return next({
				status: 400,
				message: 'Invalid Email/Password.'
			})
		}
	}
	catch(error){
		return next(error);
	}
};
const signOut = async function(req, res, next){
	console.log('sining_out');
	res.status(200).cookie(JWT_COOKIE_NAME,'null',{maxAge: 1}).send('success!');
};
const signUp = async function(req, res, next){
	try{
		const user = await User.create(req.body);
		const token = jwt.sign({
			id: user.id,
			[colName.EMAIL]: user[colName.EMAIL],
			[colName.NAME]: user[colName.NAME]
		},process.env.SECRET_KEY,{
			expiresIn: MAX_TOKEN_AGE_SEC
		});
		
		res.status(200).cookie(
			JWT_COOKIE_NAME,
			token,
			{
				httpOnly: true,
			   	maxAge: MAX_TOKEN_AGE_SEC
			}).json({
			id: user.id,
			[colName.EMAIL]: user[colName.EMAIL],
			[colName.NAME]: user[colName.NAME]
		});
	}
	catch(error){
		if(error.code == 11000){
			error.message = "EMAIL already exists, duplicate field is not allowed"
		}
		return next({
			status: 400,
			message: error.message
		});
	}
};

